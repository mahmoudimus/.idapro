api_database = {
    "ntdll": {
        "name": "ntdll.dll",
        "functions": ["NtSetInformationThread", "NtGetInformationThread"],
    },
    "kernel32": {"name": "kernel32.dll", "functions": []},
    "kernelbase": {"name": "kernelbase.dll", "functions": []},
    "user32": {"name": "user32.dll", "functions": []},
    "gdi32": {"name": "gdi32.dll", "functions": []},
    "shell32": {"name": "shell32.dll", "functions": []},
    "nsi": {"name": "nsi.dll", "functions": []},
    "shlwapi": {"name": "shlwapi.dll", "functions": []},
    "ole32": {"name": "ole32.dll", "functions": []},
    "combase": {"name": "combase.dll", "functions": []},
    "imm32": {"name": "imm32.dll", "functions": []},
    "msvcrt": {"name": "msvcrt.dll", "functions": []},
    "oleaut32": {"name": "oleaut32.dll", "functions": []},
    "shcore": {"name": "SHCore.dll", "functions": []},
    "sechost": {"name": "sechost.dll", "functions": []},
    "setupapi": {"name": "setupapi.dll", "functions": []},
    "advapi32": {"name": "advapi32.dll", "functions": []},
    "clbcatq": {"name": "clbcatq.dll", "functions": []},
    "ws2_32": {"name": "ws2_32.dll", "functions": []},
    "rpcrt4": {"name": "rpcrt4.dll", "functions": []},
    "msctf": {"name": "msctf.dll", "functions": []},
    "imagehlp": {"name": "imagehlp.dll", "functions": []},
    "crypt32": {"name": "crypt32.dll", "functions": []},
    "ucrtbase": {"name": "ucrtbase.dll", "functions": []},
    "msvcp_win": {"name": "msvcp_win.dll", "functions": []},
    "bcryptprimitives": {"name": "bcryptprimitives.dll", "functions": []},
    "wintypes": {"name": "WinTypes.dll", "functions": []},
    "gdi32full": {"name": "gdi32full.dll", "functions": []},
    "wintrust": {"name": "wintrust.dll", "functions": []},
    "win32u": {"name": "win32u.dll", "functions": []},
    "profapi": {"name": "profapi.dll", "functions": []},
    "cfgmgr32": {"name": "cfgmgr32.dll", "functions": []},
    "devobj": {"name": "devobj.dll", "functions": []},
    "bcrypt": {"name": "bcrypt.dll", "functions": []},
    "ncrypt": {"name": "ncrypt.dll", "functions": []},
    "ntasn1": {"name": "ntasn1.dll", "functions": []},
    "wldp": {"name": "wldp.dll", "functions": []},
    "msasn1": {"name": "msasn1.dll", "functions": []},
    "cryptbase": {"name": "cryptbase.dll", "functions": []},
    "cryptsp": {"name": "cryptsp.dll", "functions": []},
    "userenv": {"name": "userenv.dll", "functions": []},
    "mswsock": {"name": "mswsock.dll", "functions": []},
    "sspicli": {"name": "sspicli.dll", "functions": []},
    "ntmarta": {"name": "ntmarta.dll", "functions": []},
    "kernel.appcore": {"name": "kernel.appcore.dll", "functions": []},
    "rsaenh": {"name": "rsaenh.dll", "functions": []},
    "schannel": {"name": "schannel.dll", "functions": []},
    "powrprof": {"name": "powrprof.dll", "functions": []},
    "umpdc": {"name": "umpdc.dll", "functions": []},
    "dnsapi": {"name": "dnsapi.dll", "functions": []},
    "iphlpapi": {"name": "IPHLPAPI.DLL", "functions": []},
    "winsta": {"name": "winsta.dll", "functions": []},
    "windows.storage": {"name": "windows.storage.dll", "functions": []},
    "dxgi": {"name": "dxgi.dll", "functions": []},
    "d3d11": {"name": "d3d11.dll", "functions": []},
    "directxdatabasehelper": {"name": "directxdatabasehelper.dll", "functions": []},
    "dxcore": {"name": "DXCore.dll", "functions": []},
    "propsys": {"name": "propsys.dll", "functions": []},
    "winmm": {"name": "winmm.dll", "functions": []},
    "resourcepolicyclient": {"name": "ResourcePolicyClient.dll", "functions": []},
    "dwmapi": {"name": "dwmapi.dll", "functions": []},
    "uxtheme": {"name": "uxtheme.dll", "functions": []},
    "apphelp": {"name": "apphelp.dll", "functions": []},
    "wtsapi32": {"name": "wtsapi32.dll", "functions": []},
    "secur32": {"name": "secur32.dll", "functions": []},
    "dcomp": {"name": "dcomp.dll", "functions": []},
    "microsoft.internal.warppal": {
        "name": "Microsoft.Internal.WarpPal.dll",
        "functions": [],
    },
    "fwpuclnt": {"name": "FWPUCLNT.DLL", "functions": []},
    "dhcpcsvc6": {"name": "dhcpcsvc6.dll", "functions": []},
    "dhcpcsvc": {"name": "dhcpcsvc.dll", "functions": []},
    "igd10um64xe": {"name": "igd10um64xe.dll", "functions": []},
    "winhttp": {"name": "winhttp.dll", "functions": []},
    "intelcontrollib": {"name": "IntelControlLib.dll", "functions": []},
    "mmdevapi": {"name": "MMDevAPI.dll", "functions": []},
    "rasadhlp": {"name": "rasadhlp.dll", "functions": []},
    "mscms": {"name": "mscms.dll", "functions": []},
    "version": {"name": "version.dll", "functions": []},
    "twinapi.appcore": {"name": "twinapi.appcore.dll", "functions": []},
    "onecoreuapcommonproxystub": {
        "name": "OneCoreUAPCommonProxyStub.dll",
        "functions": [],
    },
    "cryptnet": {"name": "cryptnet.dll", "functions": []},
    "drvstore": {"name": "drvstore.dll", "functions": []},
    "wdmaud": {"name": "wdmaud.drv", "functions": []},
    "msacm32": {"name": "msacm32.drv", "functions": []},
    "midimap": {"name": "midimap.dll", "functions": []},
    "nvapi64": {"name": "nvapi64.dll", "functions": []},
    "textinputframework": {"name": "TextInputFramework.dll", "functions": []},
    "winmmbase": {"name": "winmmbase.dll", "functions": []},
    "vcruntime140_1": {"name": "vcruntime140_1.dll", "functions": []},
    "nvmessagebus": {"name": "NvMessageBus.dll", "functions": []},
    "vcruntime140": {"name": "vcruntime140.dll", "functions": []},
    "rdpendp": {"name": "rdpendp.dll", "functions": []},
    "comctl32": {"name": "comctl32.dll", "functions": []},
    "msvcp140": {"name": "msvcp140.dll", "functions": []},
    "audioses": {"name": "AudioSes.dll", "functions": []},
    "onecorecommonproxystub": {"name": "OneCoreCommonProxyStub.dll", "functions": []},
    "d3d12": {"name": "D3D12.dll", "functions": []},
    "ncryptsslp": {"name": "ncryptsslp.dll", "functions": []},
    "nvldumdx": {"name": "nvldumdx.dll", "functions": []},
    "nvgpucomp64": {"name": "nvgpucomp64.dll", "functions": []},
    "actxprxy": {"name": "actxprxy.dll", "functions": []},
    "nvwgf2umx": {"name": "nvwgf2umx.dll", "functions": []},
    "nviewh64": {"name": "nviewH64.dll", "functions": []},
    "libxell": {"name": "libxell.dll", "functions": []},
    "d3dscache": {"name": "D3DSCache.dll", "functions": []},
    "d3d12core": {"name": "D3D12Core.dll", "functions": []},
    "icm32": {"name": "icm32.dll", "functions": []},
    "wow.exe": {"name": "Wow.exe", "functions": []},
    "directxapps.sdb": {"name": "DirectXApps.sdb", "functions": []},
    "sortdefault.nls": {"name": "SortDefault.nls", "functions": []},
    "shmem": {"name": "shmem", "functions": []},
    "mswsock.dll.mui": {"name": "mswsock.dll.mui", "functions": []},
    "locale.nls": {"name": "locale.nls", "functions": []},
    "c_437.nls": {"name": "C_437.NLS", "functions": []},
    "c_1252.nls": {"name": "C_1252.NLS", "functions": []},
    "l_intl.nls": {"name": "l_intl.nls", "functions": []},
    "crypt32.dll.mui": {"name": "crypt32.dll.mui", "functions": []},
    "user32.dll.mui": {"name": "user32.dll.mui", "functions": []},
}


# --- API Database Conversion ---
def convert_api_database(api_db):
    """
    Convert all string values in the API database to our simulated UNICODE_STRING.
    The DLL "name" and each function name are converted.
    """
    new_db = {}
    for key, info in api_db.items():
        new_info = {}
        new_info["name"] = info["name"].encode("utf-16le")
        new_info["functions"] = [func.encode("utf-16le") for func in info["functions"]]
        new_db[key] = new_info
    return new_db


apidb = convert_api_database(api_database)


# --- Hash Functions ---
# Define the standard 32-bit FNV-1a hash function.
def fnv1a_32(byte_sequence: bytes, lower=True) -> int:
    fnv_prime = 0x01000193
    h = 0x811C9DC5  # FNV1a offset basis
    data_length = len(byte_sequence)
    for byte_val in byte_sequence[:data_length]:
        # Lowercase the byte value itself
        final_byte = byte_val | 0x20 if lower else byte_val
        h = h ^ final_byte
        h = (h * fnv_prime) & 0xFFFFFFFF  # Keep it 32 bits
    return h


def fnv1a_64(byte_sequence: bytes, lower=True) -> int:
    fnv_prime = 0x100000001B3
    h = 0xCBF29CE484222325  # FNV1a offset basis
    data_length = len(byte_sequence)
    for byte_val in byte_sequence[:data_length]:
        # Lowercase the byte value itself
        final_byte = byte_val | 0x20 if lower else byte_val
        h = h ^ final_byte
        h = (h * fnv_prime) & 0xFFFFFFFFFFFFFFFF  # Keep it 64 bits
    return h


# Placeholder function
def get_module_list_entries():
    """
    Placeholder: Returns a list of tuples: (name_buffer_bytes, name_length_in_bytes).
    Replace with actual PEB parsing logic if needed.
    """
    # Example for demonstration
    example_modules = [
        # Using a hypothetical name that *might* match the hash
        ("some_module.sys", "some_module.sys".encode("utf-16le")),
        ("example.dll", "example.dll".encode("utf-16le")),
        ("ntdll.dll", "ntdll.dll".encode("utf-16le")),
        ("kernel32.dll", "kernel32.dll".encode("utf-16le")),
    ]
    # IMPORTANT: The length MUST match the UNICODE_STRING.Length (bytes, no null)
    return [(name_bytes, len(name_bytes)) for _, name_bytes in example_modules]


def find_module_by_hash_python(target_hash, hash_function=fnv1a_32):
    """
    Finds a module by hashing names from a simulated module list using
    the specific hash variant found in the assembly.
    """
    # target_hash = 0x0F42198D

    for key, info in apidb.items():
        name = info["name"]
        if not name:
            continue

        name_bytes = name
        # Calculate hash using the specific assembly variant
        current_hash = hash_function(name_bytes)

        # Compare hash
        if current_hash != target_hash:
            continue

        # Retrieve the original string name for display purposes if possible
        try:
            original_name = name_bytes[: len(name_bytes)].decode(
                "utf-16le", errors="ignore"
            )
        except:
            original_name = "[cannot decode name]"
        print(
            f"Found module with hash {target_hash:#010x} (Name: '{original_name}') for key: {key}"
        )
        return True  # Module found

    print(f"Module with hash {target_hash:#010x} not found in the simulated list.")
    return False

    # # Check each function
    # for func_unicode in info["functions"]:
    #     func = func_unicode["Buffer"]
    #     if use_buggy:
    #         func_hash = buggy_hash_from_unicode_string(func_unicode)
    #         truncated = func[: func_unicode["Length"] // 2]
    #     else:
    #         func_hash = fnv1a_32(func)
    #         truncated = func

    #     if func_hash == target_hash:
    #         matches.append(
    #             f"Function: {func} in {full_name} (hash of '{truncated}')"
    #         )


# --- Print Hash Table using the UNICODE_STRING values ---
def print_hash_table(apidb, debug=False):
    if not debug:
        return

    print("API Hash Lookup Table (32-bit and 64-bit):")
    print("-" * 80)

    for dll, info in apidb.items():
        # info["name"] is now a UNICODE_STRING structure.
        dll_unicode = info["name"]
        # Correct (full) hash using the complete string.
        dll_hash32 = fnv1a_32(dll_unicode)
        dll_hash64 = fnv1a_64(dll_unicode)

        print(f"\n{dll}:")
        print(f"  DLL: {dll}")
        print(f"    32-bit: 0x{dll_hash32:08X}")
        print(f"    64-bit: 0x{dll_hash64:016X}")

        # Process each function name.
        for func_unicode in info["functions"]:
            func_hash32 = fnv1a_32(func_unicode)
            func_hash64 = fnv1a_64(func_unicode)
            func_name = func_unicode[: len(func_unicode)].decode(
                "utf-16le", errors="ignore"
            )
            print(f"  Function: {func_name}")
            print(f"    32-bit: 0x{func_hash32:08X}")
            print(f"    64-bit: 0x{func_hash64:016X}")


if __name__ == "__main__":
    found = find_module_by_hash_python(target_hash=0x0F42198D)

    # Verify hash calculation for ntdll.dll using the assembly's method
    ntdll_bytes = apidb["ntdll"]["name"]
    ntdll_hash_variant = fnv1a_32(ntdll_bytes)
    print(
        f"\nVerification: Hash for 'ntdll.dll' using assembly variant: {ntdll_hash_variant:#010x}"
    )
    print(
        f"Target hash from assembly constant calculation:             {0x0F42198D:#010x}"
    )
    # print_hash_table(apidb, debug=True)
